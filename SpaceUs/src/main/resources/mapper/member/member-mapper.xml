<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="member">

<select id="selectOneMember" resultMap="memberMap">
	select
		* 
	from
		member
	where
		member_email = #{ memberEmail }
</select>

<select id="selectOneNickName" resultMap="memberMap">
	select
		* 
	from
		member
	where
		nickname = #{ nickName }
</select>

<select id="selectOnePhone" resultMap="memberMap">
	select
		* 
	from
		member
	where
		member_phone = #{ phone }
</select>


<insert id="insertMember">
	insert all
		into member values (
			#{ memberEmail },
			#{ nickName },
			#{ password },
			#{ memberPhone },
			#{ birthDay },
			default,
			default
		)
		into auth values (
			#{ memberEmail },
			default
		)
	select * from dual
</insert>

<update id="updatePassword">

	update
		member
	set
		password = #{ encryptedNewPassword }
	where
		member_email = #{ tomail }
</update>

<update id="updateStamp">
	update
		member
	set
		attendance_cnt = attendance_cnt + 1,
		today = today +1
	where
		member_email = #{ email }
</update>

<update id="updateMember">
	update
		member
	<set>
      <if test="nickName != null">nickname = #{ nickName },</if>
      <if test="memberPhone != null">member_phone = #{ memberPhone }</if>
   </set>
	where
		member_email = #{ memberEmail }
</update>

<select id="selectBtdList" parameterType="string" resultMap="memberMap">
	select
		* 
	from
		member
	where
		birthday = to_date(#{ format }, 'MM/dd')
</select>

<resultMap type="member" id="memberMap">
	<id column="member_email" property="memberEmail"/>
	<result column="nickname" property="nickName"/>
	<result column="password" property="password"/>
	<result column="member_phone" property="memberPhone"/>
	<result column="birthday" property="birthDay"/>
	<result column="member_regdate" property="memberRegDate"/>
	<result column="attendance_cnt" property="attendanceCnt"/>
</resultMap>

<update id="deleteAttendance">
    update  
    	member 
    set 
    	attendance_cnt = 0
</update> 

<delete id="deleteMember">
    delete from 
       member 
    where 
       member_email = #{ memberEmail}
</delete>

<update id="updatePwd">
	update
		member
	set
		password = #{ password }
	where
		member_email = #{ memberEmail }
</update>

<insert id="insertBtdCoupon">
	insert all
    into coupon 
    values(
            'C'||seq_coupon_no.nextval,
            'btd',
            member_email,
            0.3,
            default,
            sysdate+7,
            default
    )
 	select
		member_email
	from
		member
	where
		birthday like '%%/'||(select to_char(sysdate+1, 'MM/dd') sys_month from dual)
</insert>

<update id="deleteToday">
	update
		member
	set
		today = 0
</update>


<insert id="insertAttend3Coupon">
	insert all
    into coupon
    values(
            'C'||seq_coupon_no.nextval,
            'attend3',
            member_email,
            0.3,
            default,
            sysdate+7,
            default
    )
	select member_email from member where attendance_cnt >=3
</insert>

<insert id="insertAttend2Coupon">
	insert all
    into coupon
    values(
            'C'||seq_coupon_no.nextval,
            'attend2',
            member_email,
            0.2,
            default,
            sysdate+7,
            default
    )
	select member_email from member <![CDATA[where attendance_cnt >=2 and attendance_cnt < 3]]> 
</insert>




</mapper>